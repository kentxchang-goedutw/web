<html>
<head>
<base href="https://youtube-interactive-quiz.com/">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YouTube 互動式問答</title>
<style>
  /* 保留所有原有的樣式 */
  body, html {
    font-family: "Microsoft JhengHei", Arial, sans-serif;
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
    background-color: #f0f0f0;
  }
  #app {
    max-width: 800px;
    margin: 0 auto;
    background-color: white;
    padding: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    height: 100%;
    box-sizing: border-box;
    overflow-y: auto;
    position: relative;
  }
  h1 {
    color: #ff0000;
    margin-top: 0;
    text-align: center;
    font-size: 2.5em;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
  }
  input, button, select {
    margin: 10px 0;
    padding: 12px;
    width: 100%;
    box-sizing: border-box;
    border-radius: 5px;
    border: 1px solid #ddd;
    font-size: 1em;
  }
  button {
    background-color: #ff0000;
    color: white;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.1s;
    font-weight: bold;
  }
  button:hover {
    background-color: #cc0000;
    transform: translateY(-2px);
  }
  button:active {
    transform: translateY(0);
  }
  #playerContainer {
    position: relative;
    width: 100%;
    padding-top: 56.25%;
    margin-bottom: 20px;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }
  #player {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }
  #quizPoints {
    margin-top: 20px;
    display: none;
  }
  .quiz-point {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid #ddd;
    background-color: #f9f9f9;
    border-radius: 5px;
    margin-bottom: 10px;
    transition: background-color 0.3s;
  }
  .quiz-point:hover {
    background-color: #f0f0f0;
  }
  .delete-btn {
    background-color: #ff4444;
    color: white;
    border: none;
    padding: 8px 12px;
    cursor: pointer;
    border-radius: 5px;
    font-size: 0.9em;
  }
  #quizModal, #addQuizModal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.8);
    backdrop-filter: blur(5px);
  }
  .modal-content {
    background-color: white;
    margin: 10% auto;
    padding: 30px;
    border-radius: 15px;
    width: 80%;
    max-width: 600px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    animation: modalFadeIn 0.5s;
  }
  @keyframes modalFadeIn {
    from { opacity: 0; transform: translateY(-50px); }
    to { opacity: 1; transform: translateY(0); }
  }
  #quizQuestion {
    font-size: 1.5em;
    color: #333;
    margin-bottom: 20px;
    text-align: center;
    font-weight: bold;
  }
  .quiz-option {
    display: block;
    margin: 15px 0;
    padding: 15px;
    width: 100%;
    text-align: left;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 1.1em;
    color: #333;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .quiz-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  .quiz-option:active {
    transform: translateY(0);
  }
  #quizContainer {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #f0f0f0;
    z-index: 1000;
    text-align: center;
  }
  #quizPlayerContainer {
    width: 80%;
    height: 80%;
    margin: 0 auto;
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: #000;
    position: relative;
  }
  #quizPlayer {
    width: 100%;
    height: 100%;
    max-width: 1280px;
  }
  #toggleButton {
    width: 100%;
    margin-top: 10px;
    background-color: #4CAF50;
    display: none;
  }
  #importSection {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: white;
    z-index: 1002;
    padding: 20px;
    box-sizing: border-box;
    overflow-y: auto;
  }
  #importSection h2 {
    text-align: center;
    color: #ff0000;
  }
  #importTextarea {
    width: 100%;
    height: 200px;
    margin-bottom: 10px;
    padding: 10px;
    box-sizing: border-box;
  }
  #importTable {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }
  #importTable th, #importTable td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
  }
  #importTable th {
    background-color: #f2f2f2;
  }
  #tableContainer {
    max-height: 300px;
    overflow-y: auto;
  }
  #bankQuestionSelect {
    width: 100%;
    padding: 10px;
    margin-top: 10px;
    font-size: 1em;
    border-radius: 5px;
    border: 1px solid #ddd;
    display: none;
  }
  #confirmBankQuestion {
    display: none;
    margin-top: 10px;
  }
  #backToHome {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    padding: 10px 20px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
    transition: background-color 0.3s;
  }
  #backToHome:hover {
    background-color: #45a049;
  }
  #quizResults {
    position: absolute;
    bottom: 60px;
    left: 0;
    width: 100%;
    max-height: calc(20% - 60px);
    overflow-y: auto;
    background-color: rgba(255, 255, 255, 0.9);
    padding: 10px;
    box-sizing: border-box;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
  }
  .result-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
    font-size: 14px;
    padding: 5px;
    border-bottom: 1px solid #eee;
  }
  #closeImportSection {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 30px;
    height: 30px;
    background-color: #ff0000;
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 20px;
    line-height: 30px;
    text-align: center;
    cursor: pointer;
    z-index: 1003;
  }
  #importButton, #onlineImportButton {
    padding: 10px 20px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
    transition: background-color 0.3s;
    margin-top: 10px;
  }
  #importButton:hover, #onlineImportButton:hover {
    background-color: #45a049;
  }
  #fileInput {
    display: none;
  }
  #urlSelect {
    display: none;
    margin-top: 10px;
  }
  /* 新增問題點標記的樣式 */
  .quiz-marker {
    position: absolute;
    bottom: 0;
    width: 2px;
    height: 10px;
    background-color: yellow;
    transform: translateX(12px);
  }
  /* 新增時間軸下方的問題點容器樣式 */
  #quizMarkersContainer {
    position: absolute;
    bottom: 5px;
    left: 0;
    width: 100%;
    height: 10px;
    pointer-events: none;
  }
</style>
</head>
<body>
<div id="app">
  <h1>YouTube 互動式問答</h1>
  <button id="importButton">匯入</button>
  <button id="onlineImportButton">從線上匯入</button>
  <select id="urlSelect">
    <option value="">選擇一個網址</option>
    <option value="https://kentxchang-goedutw.github.io/web/youtubequiz/demo.json">Demo網址1</option>
    <option value="https://kentxchang-goedutw.github.io/web/youtubequiz/demo2.json">Demo網址2</option>
    <option value="https://example.com/quiz3.json">網址3</option>
  </select>
  <div id="playerContainer">
    <div id="player"></div>
  </div>
  <button id="addQuizPoint" style="display: none;">新增問題點</button>
  <button id="startQuiz">開始問題</button>
  <div id="quizPoints"></div>
</div>

<div id="quizContainer">
  <div id="quizPlayerContainer">
    <div id="quizPlayer"></div>
    <div id="quizMarkersContainer"></div> <!-- 新增的問題點標記容器 -->
  </div>
  <div id="quizModal">
    <div class="modal-content">
      <h2 id="quizQuestion"></h2>
      <div id="quizOptions"></div>
    </div>
  </div>
  <div id="quizResults"></div>
  <button id="backToHome">回到首頁</button>
</div>

<input type="file" id="fileInput" accept=".json">

<script src="https://www.youtube.com/iframe_api"></script>
<script>
let player;
let quizPlayer;
let quizPoints = [];
let currentQuizIndex = 0;
let isQuizMode = false;
let checkInterval;
let questionBank = [];
let currentQuizTime;
let quizResults = [];

// 預設的 JSON 文件 URL，可以修改此 URL 以預設匯入其他 JSON 文件
const defaultJsonUrl = "https://kentxchang-goedutw.github.io/web/youtubequiz/demo.json";

function onYouTubeIframeAPIReady() {
  // YouTube API 準備就緒
  fetch(defaultJsonUrl)
    .then(response => response.json())
    .then(data => loadQuizData(data))
    .catch(error => alert('無法載入預設的 JSON 文件'));
}

document.getElementById('importButton').addEventListener('click', () => {
  document.getElementById('fileInput').click();
});

document.getElementById('fileInput').addEventListener('change', () => {
  const file = document.getElementById('fileInput').files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const jsonData = JSON.parse(e.target.result);
        loadQuizData(jsonData);
      } catch (error) {
        alert('無效的 JSON 文件');
      }
    };
    reader.readAsText(file);
  }
});

document.getElementById('onlineImportButton').addEventListener('click', () => {
  const urlSelect = document.getElementById('urlSelect');
  if (urlSelect.style.display === 'none') {
    urlSelect.style.display = 'block';
  } else {
    urlSelect.style.display = 'none';
  }
});

document.getElementById('urlSelect').addEventListener('change', () => {
  const selectedUrl = document.getElementById('urlSelect').value;
  if (selectedUrl) {
    fetch(selectedUrl)
      .then(response => response.json())
      .then(data => loadQuizData(data))
      .catch(error => alert('無法載入選定的 JSON 網址'));
  }
});

function loadQuizData(data) {
  const { youtubeUrl, quizPoints: points } = data;
  const videoId = extractVideoId(youtubeUrl);

  if (videoId) {
    player = new YT.Player('player', {
      height: '360',
      width: '640',
      videoId: videoId,
      events: {
        'onReady': onPlayerReady,
        'onStateChange': onPlayerStateChange
      }
    });
    quizPoints = points.map(point => ({
      time: point.time,
      question: point.question,
      options: point.options,
      correctAnswer: point.correctAnswer,
      wrongAttempts: 0
    }));
    updateQuizPointsDisplay();
    document.getElementById('quizPoints').style.display = 'none';
  } else {
    alert('無效的 YouTube 網址');
  }
}

function extractVideoId(url) {
  const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
  const match = url.match(regExp);
  return (match && match[7].length == 11) ? match[7] : false;
}

function onPlayerReady(event) {
  // 影片準備就緒
  addQuizMarkers();
}

function onPlayerStateChange(event) {
  // 不在這裡處理 isQuizMode，因為這是預覽播放器的事件
}

function addQuizMarkers() {
  const duration = player.getDuration();
  quizPoints.forEach(point => {
    const marker = document.createElement('div');
    marker.className = 'quiz-marker';
    marker.style.left = (point.time / duration * 100) + '%';
    document.getElementById('quizMarkersContainer').appendChild(marker);
  });
}

document.getElementById('startQuiz').addEventListener('click', () => {
  if (quizPoints.length === 0) {
    alert('請先添加問題點');
    return;
  }
  isQuizMode = true;
  currentQuizIndex = 0;
  const videoId = player.getVideoData().video_id;
  document.getElementById('quizContainer').style.display = 'block';
  document.getElementById('app').style.display = 'none';
  
  quizPlayer = new YT.Player('quizPlayer', {
    height: '100%',
    width: '100%',
    videoId: videoId,
    playerVars: {
      'autoplay': 1,
      'controls': 1,
      'rel': 0,
      'showinfo': 0
    },
    events: {
      'onReady': onQuizPlayerReady,
      'onStateChange': onQuizPlayerStateChange
    }
  });
  
  // 初始化答題結果
  quizResults = quizPoints.map(point => ({
    question: point.question,
    wrongAttempts: 0,
    answered: false
  }));
  updateQuizResults();
});

function onQuizPlayerReady(event) {
  quizPlayer.playVideo();
  startCheckingQuizPoints();
}

function onQuizPlayerStateChange(event) {
  if (event.data == YT.PlayerState.PLAYING) {
    startCheckingQuizPoints();
  } else if (event.data == YT.PlayerState.PAUSED || event.data == YT.PlayerState.ENDED) {
    stopCheckingQuizPoints();
  }
}

function startCheckingQuizPoints() {
  checkInterval = setInterval(checkQuizPoint, 1000); // 每秒檢查一次
}

function stopCheckingQuizPoints() {
  clearInterval(checkInterval);
}

function checkQuizPoint() {
  const currentTime = quizPlayer.getCurrentTime();
  const nextQuizPoint = quizPoints[currentQuizIndex];
  
  if (nextQuizPoint && currentTime >= nextQuizPoint.time) {
    quizPlayer.pauseVideo();
    showQuiz(nextQuizPoint);
    stopCheckingQuizPoints(); // 暫停檢查，等待回答問題
  }
}

function showQuiz(quizPoint) {
  const modal = document.getElementById('quizModal');
  const question = document.getElementById('quizQuestion');
  const options = document.getElementById('quizOptions');
  
  const colors = ['#FFDDC1', '#FFABAB', '#FFC3A0', '#FF677D'];

  question.textContent = quizPoint.question;
  options.innerHTML = quizPoint.options.map((option, index) => `
    <button class="quiz-option" style="background-color: ${colors[index]};" onclick="checkAnswer(${index})">${option}</button>
  `).join('');
  
  modal.style.display = 'block';
}

function checkAnswer(selectedIndex) {
  const currentQuiz = quizPoints[currentQuizIndex];
  if (selectedIndex === currentQuiz.correctAnswer) {
    alert('答對了！');
    document.getElementById('quizModal').style.display = 'none';
    quizResults[currentQuizIndex].answered = true;
    currentQuizIndex++;
    updateQuizResults();
    quizPlayer.playVideo();
    startCheckingQuizPoints(); // 繼續檢查下一個問題點
  } else {
    alert('答錯了，請再試一次。');
    quizResults[currentQuizIndex].wrongAttempts++;
  }
}

function updateQuizResults() {
  const resultsContainer = document.getElementById('quizResults');
  resultsContainer.innerHTML = quizResults.map((result, index) => {
    if (result.answered) {
      return `
        <div class="result-item">
          <span>問題 ${index + 1}: ${result.question}</span>
          <span>答錯次數: ${result.wrongAttempts}</span>
        </div>
      `;
    }
    return '';
  }).join('');
}

function updateQuizPointsDisplay() {
  const quizPointsDiv = document.getElementById('quizPoints');
  quizPointsDiv.innerHTML = quizPoints.map((point, index) => `
    <div class="quiz-point">
      <span>時間：${formatTime(point.time)} - 問題：${point.question}</span>
      <button class="delete-btn" onclick="deleteQuizPoint(${index})">刪除</button>
    </div>
  `).join('');
}

function deleteQuizPoint(index) {
  quizPoints.splice(index, 1);
  updateQuizPointsDisplay();
}

function formatTime(seconds) {
  const minutes = Math.floor(seconds / 60);
  const remainingSeconds = Math.round(seconds % 60);
  return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
}

// 新增回到首頁功能
document.getElementById('backToHome').addEventListener('click', () => {
  if (quizPlayer && quizPlayer.stopVideo) {
    quizPlayer.stopVideo();
  }
  document.getElementById('quizContainer').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  isQuizMode = false;
  currentQuizIndex = 0;
});
</script>
</body>
</html>
